"use strict";var R=(e,r,s)=>{if(!r.has(e))throw TypeError("Cannot "+s)};var d=(e,r,s)=>(R(e,r,"read from private field"),s?s.call(e):r.get(e)),S=(e,r,s)=>{if(r.has(e))throw TypeError("Cannot add the same private member more than once");r instanceof WeakSet?r.add(e):r.set(e,s)},U=(e,r,s,n)=>(R(e,r,"write to private field"),n?n.call(e,s):r.set(e,s),s);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const t=require("@fi-sci/misc"),l=require("react"),L=require("react/jsx-runtime"),V=e=>t.validateObject(e,{type:t.isEqualTo("getFigureData")}),b=e=>t.validateObject(e,{type:t.isEqualTo("getFigureData"),figureData:()=>!0}),W=e=>t.validateObject(e,{type:t.isEqualTo("getFileData"),uri:t.optional(t.isString),responseType:t.optional(t.isString),startByte:t.optional(t.isNumber),endByte:t.optional(t.isNumber)}),T=e=>t.validateObject(e,{type:t.isEqualTo("getFileData"),fileData:t.optional(()=>!0),errorMessage:t.optional(t.isString)}),H=e=>t.validateObject(e,{type:t.isEqualTo("getFileDataUrl"),uri:t.optional(t.isString)}),M=e=>t.validateObject(e,{type:t.isEqualTo("getFileDataUrl"),fileDataUrl:t.optional(t.isString),errorMessage:t.optional(t.isString)}),K=e=>t.validateObject(e,{type:t.isEqualTo("storeFile"),fileData:t.isString,uri:t.optional(t.isString),jotId:t.optional(()=>!0)}),C=e=>t.validateObject(e,{type:t.isEqualTo("storeFile"),uri:t.optional(t.isString),error:t.optional(t.isString)}),_=e=>t.validateObject(e,{type:t.isEqualTo("storeGithubFile"),fileData:t.isString,uri:t.isString}),j=e=>t.validateObject(e,{type:t.isEqualTo("storeGithubFile"),success:t.isBoolean,error:t.optional(t.isString)}),X=e=>t.validateObject(e,{type:t.isEqualTo("setUrlState"),state:t.isJSONObject}),P=e=>t.validateObject(e,{type:t.isEqualTo("setUrlState")}),Y=e=>t.validateObject(e,{type:t.isEqualTo("serviceQuery"),serviceName:t.isString,query:()=>!0,includeUserId:t.optional(t.isBoolean)}),B=e=>t.validateObject(e,{type:t.isEqualTo("serviceQuery"),result:t.optional(()=>!0),binaryPayload:t.optional(()=>!0),errorMessage:t.optional(t.isString)}),Z=e=>t.validateObject(e,{type:t.isEqualTo("readDir"),uri:t.isString}),ee=e=>t.validateObject(e,{name:t.isString,size:t.isNumber,mtime:t.isNumber}),x=e=>t.validateObject(e,{name:t.optional(t.isString),files:t.isArrayOf(ee),dirs:t.isArrayOf(x)}),G=e=>t.validateObject(e,{type:t.isEqualTo("readDir"),dir:t.optional(x),errorMessage:t.optional(t.isString)}),te=e=>t.isOneOf([V,W,H,K,_,X,Y,Z])(e),re=e=>t.isOneOf([b,T,M,C,j,P,B,G])(e),se=e=>t.validateObject(e,{type:t.isEqualTo("figurlResponse"),requestId:t.isString,response:re}),ne=e=>t.validateObject(e,{type:t.isEqualTo("setCurrentUser"),userId:t.optional(t.isString),googleIdToken:t.optional(t.isString)}),ie=e=>t.validateObject(e,{type:t.isEqualTo("fileDownloadProgress"),uri:t.isString,loaded:t.isNumber,total:t.isNumber}),oe=e=>t.validateObject(e,{type:t.isEqualTo("messageToFrontend"),message:()=>!0}),ae=e=>t.validateObject(e,{type:t.isEqualTo("reportUrlStateChange"),state:()=>!0}),le=e=>t.isOneOf([se,ne,ie,oe,ae])(e);function ue(e){const r=e.indexOf("?");if(r<0)return{};const s={},n=e.slice(r+1).split("&");for(let i=0;i<n.length;i++){const o=n[i].split("=");s[decodeURIComponent(o[0])]=decodeURIComponent(o[1]||"")}return s}const ce=ue(window.location.href),de=(e,{parentOrigin:r})=>{(ce.useOpener==="1"?window.opener:window.parent).postMessage(e,r)};function ge(e){const r=e.indexOf("?");if(r<0)return{};const s={},n=e.slice(r+1).split("&");for(let i=0;i<n.length;i++){const o=n[i].split("=");s[decodeURIComponent(o[0])]=decodeURIComponent(o[1]||"")}return s}const E=ge(window.location.href),I={},pe=e=>{const r=e.requestId,s=e.response;r in I&&(I[r].onResponse(s),delete I[r])};let f;const $=[];window.addEventListener("message",e=>{if(f)return;const r=e.data;r.type==="initializeFigure"&&(f={parentOrigin:r.parentOrigin,figureId:r.figureId,s:r.s},$.forEach(s=>{s()}))});const fe=e=>{f?e():$.push(e)},N=async()=>new Promise((e,r)=>{const s=E.figureId,n=E.parentOrigin,i=E.s||"";s!==void 0&&n!==void 0?e({parentOrigin:n,figureId:s,s:i}):fe(()=>{if(!f)throw Error("unexpected");e({parentOrigin:f.parentOrigin,figureId:f.figureId,s:f.s})})}),p=async e=>{const{figureId:r,parentOrigin:s}=await N();return new Promise((n,i)=>{const o=Q(10);I[o]={onResponse:a=>{n(a)},onError:a=>{i(a)}},de({type:"figurlRequest",figureId:r,requestId:o,request:e},{parentOrigin:s})})},Q=e=>{if(!e)throw Error("randomAlphaString: num_chars needs to be a positive integer.");let r="";const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";for(let n=0;n<e;n++)r+=s.charAt(Math.floor(Math.random()*s.length));return r};var g,q;class ye{constructor(){S(this,g,{});S(this,q,{})}setUserInfo(r){U(this,q,{...r});for(const s in d(this,g))d(this,g)[s]()}get userInfo(){return d(this,q)}onChange(r){const s=Q(10);return d(this,g)[s]=r,()=>{s in d(this,g)&&delete d(this,g)[s]}}}g=new WeakMap,q=new WeakMap;const F=new ye,Se=e=>{F.setUserInfo(e)},he=()=>{const[e,r]=l.useState({});return l.useEffect(()=>(r(F.userInfo),F.onChange(()=>{r(F.userInfo)})),[]),e},qe=e=>t.validateObject(e,{type:t.isEqualTo("figurlRequest"),figureId:t.isString,requestId:t.isString,request:te}),De=e=>t.validateObject(e,{type:t.isEqualTo("messageToBackend"),figureId:t.isString,message:()=>!0}),we=e=>t.isOneOf([qe,De])(e),k=async(e,r,s={})=>{const n={type:"getFileData",uri:e};s.responseType!==void 0&&(n.responseType=s.responseType),s.startByte!==void 0&&(n.startByte=s.startByte,n.endByte=s.endByte),z[e]=({loaded:o,total:u})=>{r({loaded:o,total:u})};const i=await p(n);if(!T(i))throw Error("Invalid response to getFigureData");if(i.errorMessage)throw Error(`Error getting file data for ${e}: ${i.errorMessage}`);return i.fileData},ve=async e=>{const s=await p({type:"getFileDataUrl",uri:e});if(!M(s))throw Error("Invalid response to getFigureUrlData");if(!s.fileDataUrl||s.errorMessage)throw Error(`Error getting file data for ${e}: ${s.errorMessage}`);return s.fileDataUrl},Ue=async(e,r={})=>{const n=await p({type:"storeFile",fileData:e});if(!C(n))throw Error("Invalid response to storeFile");if(n.error)throw Error(`Error storing file data: ${n.error}`);if(n.uri===void 0)throw Error("Unexpected response.uri is undefined");return n.uri},Ie=async e=>{const r={type:"storeGithubFile",fileData:e.fileData,uri:e.uri},s=await p(r);if(!j(s))throw Error("Invalid response to storeFile");if(s.error)throw Error(`Error storing file data: ${s.error}`)},z={},Fe=({uri:e,loaded:r,total:s})=>{const n=z[e];n&&n({loaded:r,total:s})},Oe=(e,r={})=>{const[s,n]=l.useState(void 0),[i,o]=l.useState(void 0),{progress:u,reportProgress:a}=l.useMemo(()=>{let c=({loaded:v,total:ke})=>{};return{progress:{onProgress:v=>{c=v}},reportProgress:v=>{c(v)}}},[]);return l.useEffect(()=>{o(void 0),n(void 0),k(e,a,{startByte:r.startByte,endByte:r.endByte}).then(c=>{n(c)}).catch(c=>{o(c.message)})},[e,a,r.startByte,r.endByte]),{fileData:s,progress:u,errorMessage:i}};function Ee(e){const r=e.indexOf("?");if(r<0)return{};const s={},n=e.slice(r+1).split("&");for(let i=0;i<n.length;i++){const o=n[i].split("=");s[decodeURIComponent(o[0])]=decodeURIComponent(o[1]||"")}return s}const me=Ee(window.location.href),Re=JSON.parse(decodeURIComponent(me.s||"{}"));let m;N().then(e=>{m=JSON.parse(e.s||"{}")});const h=()=>m||Re,J=l.createContext({}),be=e=>{},Te=()=>{const e=l.useContext(J),{urlState:r,setUrlState:s}=e,n=l.useCallback(i=>{const o={...r||h()};let u=!1;for(const a in i){const c=i[a],w=(r||h())[a];c===void 0&&w!==void 0?(delete o[a],u=!0):(c!==void 0&&w===void 0||O(c)!==O(w))&&(o[a]=c,u=!0)}u&&s&&s(o)},[r,s]);return{urlState:r||h(),setUrlState:s||be,updateUrlState:n,initialUrlState:h()}};var D,y;class Me{constructor(){S(this,D,{});S(this,y,[])}reportUrlStateChange(r){O(r)!==O(d(this,D))&&(U(this,D,r),d(this,y).forEach(s=>s(r)))}onUrlStateChange(r){return d(this,y).push(r),()=>{U(this,y,d(this,y).filter(n=>n!==r))}}}D=new WeakMap,y=new WeakMap;const A=new Me,Ce=e=>{A.reportUrlStateChange(e)},je=e=>{const[r,s]=l.useState(h()),n=l.useCallback(o=>{(async()=>{const a=await p({type:"setUrlState",state:o});if(!P(a))throw Error("Invalid response to setUrlState")})()},[]),i=l.useMemo(()=>({urlState:r,setUrlState:n}),[r,n]);return l.useEffect(()=>A.onUrlStateChange(u=>{s(u)}),[]),L.jsx(J.Provider,{value:i,children:e.children})},O=(e,r=void 0)=>{const s=[];return JSON.stringify(e,function(n,i){return s.push(n),i}),s.sort(),JSON.stringify(e,s,r)};function Pe(e){const r=e.indexOf("?");if(r<0)return{};const s={},n=e.slice(r+1).split("&");for(let i=0;i<n.length;i++){const o=n[i].split("=");s[decodeURIComponent(o[0])]=decodeURIComponent(o[1]||"")}return s}const Be=Pe(window.location.href),xe=()=>{window.addEventListener("message",e=>{const r=e.data;if(r)if(le(r))r.type==="figurlResponse"?pe(r):r.type==="setCurrentUser"?Se({userId:r.userId,googleIdToken:r.googleIdToken}):r.type==="fileDownloadProgress"?Fe({uri:r.uri,loaded:r.loaded,total:r.total}):r.type==="reportUrlStateChange"&&Ce(r.state);else if(we(r)){if(Be.parentOrigin){console.warn("Got message to parent even though parentOrigin is defined");return}if(r.type==="figurlRequest"){const s=r.request;if(s.type==="getFigureData"){const i={type:"getFigureData",figureData:window.figurlData.figure},o={type:"figurlResponse",requestId:r.requestId,response:i};window.postMessage(o,"*")}else if(s.type==="getFileData"){const i={type:"getFileData",fileData:window.figurlData.uri[s.uri]},o={type:"figurlResponse",requestId:r.requestId,response:i};window.postMessage(o,"*")}}}else console.warn("Unhandled message from parent",e)})},Ge=async()=>{const r=await p({type:"getFigureData"});if(!b(r))throw Error("Invalid response to getFigureData");return r.figureData},$e=async(e,r,s={})=>{const n={type:"serviceQuery",serviceName:e,query:r};s.includeUserId&&(n.includeUserId=!0);const i=await p(n);if(!B(i))throw Error("Invalid response to serviceQuery");if(i.errorMessage)throw Error(`Error processing service query: ${i.errorMessage}`);return{result:i.result,binaryPayload:i.binaryPayload}},Ne=async e=>{const s=await p({type:"readDir",uri:e});if(!G(s))throw Error("Invalid response to readDir");if(s.errorMessage)throw Error(`Error reading dir for ${e}: ${s.errorMessage}`);if(!s.dir)throw Error("Unexpected, response.dir is undefined");return s.dir};exports.SetupUrlState=je;exports.getFigureData=Ge;exports.getFileData=k;exports.getFileDataUrl=ve;exports.readDir=Ne;exports.serviceQuery=$e;exports.startListeningToParent=xe;exports.storeFileData=Ue;exports.storeGithubFileData=Ie;exports.useFileData=Oe;exports.useSignedIn=he;exports.useUrlState=Te;
