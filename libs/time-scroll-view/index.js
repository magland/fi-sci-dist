"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const h=require("react/jsx-runtime"),c=require("react"),Te=require("@fi-sci/splitter"),K=require("@fi-sci/context-time-selection"),pe=require("react-draggable");require("mathjs");const G=require("react-icons/fa"),ce=require("@mui/material"),ke=require("@fi-sci/misc"),le=6,W=3,Y=15,V=20,ye=({width:e,height:t,hideVisibleTimeRange:n})=>{const{currentTimeSec:o,setCurrentTime:s,startTimeSec:i,endTimeSec:r,visibleStartTimeSec:a,visibleEndTimeSec:u,setVisibleTimeRange:f}=K.useTimeSelection(),d=c.useMemo(()=>m=>m*e,[e]),g=c.useMemo(()=>m=>m/e,[e]),{x0:x,x1:S,x2:_,y1:w,y2:T}=c.useMemo(()=>{const m=i??0,b=r??1;if(b<=m)return{x0:0,x1:void 0,x2:void 0,y1:void 0,y2:void 0};const F=o!==void 0?d((o-m)/(b-m)):0,k=a!==void 0?d((a-m)/(b-m)):void 0,y=u!==void 0?d((u-m)/(b-m)):void 0;let j=k,L=y;if(k!==void 0&&y!==void 0&&y-k<Y){const M=(k+y)/2;j=M-Y/2,L=M+Y/2}return{x0:F,x1:k,x2:y,y1:j,y2:L}},[i,r,o,a,u,d]),[p,C]=c.useState(!1),z=c.useCallback(m=>{if(p)return;const b=m.currentTarget.getBoundingClientRect(),F={x:m.clientX-b.x,y:m.clientY-b.y},k=g(F.x),y=i??0,L=y+k*((r??1)-y);s(L);const M=a!==void 0&&u!==void 0?u-a:void 0,R=M!==void 0?Math.max(L-M/2,y):void 0,P=M!==void 0&&R!==void 0?R+M:void 0;R!==void 0&&P!==void 0&&f(R,P)},[p,g,i,r,s,a,u,f]),[H,E]=c.useState({x:0,y:0}),q=c.useCallback((m,b)=>{C(!0)},[]),v=c.useCallback((m,b)=>{const F=b.x,k=i??0,y=r??1,j=a!==void 0?a:k,M=d((j-k)/(y-k))+F,R=g(M),P=k+R*(y-k),$=P+(u??1)-(a??0),X=o!==void 0?o-j+P:void 0;X!==void 0&&P<=X&&X<=$&&s(X),f(P,$),E({x:0,y:0}),C(!1)},[s,d,i,r,g,a,u,f,o]);return h.jsxs("div",{style:{position:"absolute",left:0,top:0,width:e,height:t,backgroundColor:"white",userSelect:"none"},onMouseUp:z,children:[h.jsx("div",{style:{position:"absolute",left:0,top:le,width:e,height:t-le*2,backgroundColor:"lightgray"}}),h.jsx("div",{style:{position:"absolute",left:x-1,top:0,width:3,height:t,backgroundColor:"red"}}),S!==void 0&&_!==void 0&&w!==void 0&&T!==void 0&&!n&&h.jsx(pe,{axis:"x",onDrag:(m,b)=>q(m,b),onStop:(m,b)=>v(m,b),position:H,children:h.jsx("div",{style:{position:"absolute",left:w,top:W,width:T-w+1,height:t-W*2,backgroundColor:"black"},children:h.jsx("div",{style:{position:"absolute",left:S-w,top:0,width:_-S+1,height:t-W*2,backgroundColor:"gray"}})})})]})},xe=23,Me=60,Se=(e,t,n,o)=>Array(Math.ceil((t-o)/n)).fill(0).map((s,i)=>o+i*n).filter(s=>s>e),we=(e,t)=>{let n=0;const o=Math.trunc(Math.log10(t));if(Math.trunc(Math.log10(e))!==o)return n;const s=Math.trunc(Math.log10(t-e));if(o<=s)return n;const i=s+1,r=Math.pow(10,-i),a=Math.trunc(t*r).toString(),u=Math.trunc(e*r).toString();for(const[f,d]of[...a].entries()){if(d!==u[f]){n=n*Math.pow(10,f-i);break}n=n*10+parseInt(d)}return n*Math.pow(10,i)},Pe=(e,t)=>Math.floor(e*Math.pow(10,-(t+1)))*Math.pow(10,t+1),Ce=(e,t,n)=>{const o=e-t,s=Math.trunc(o*Math.pow(10,-n)),i=s%10===0;return{label:Math.abs(n)>3?`${(s/10).toFixed(1)}e${n+1}`:`${Math.round(s*Math.pow(10,n)*1e9)/1e9}`,isMajor:i,dataValue:e}},je=(e,t,n,o,s)=>{const i=Se(t,n,o,e).map(u=>Math.round(u*1e9)/1e9),r=we(t,n);return i.map(u=>Ce(u,r,s))},ue={ticks:[],datamin:0,datamax:0},Le=(e,t)=>{const n=Math.floor(Math.log10(e/t)),o=Math.pow(10,n),s=[1,2,5,10],r=s.map(a=>e/(o*a)).findIndex(a=>a<t);return r===3?{step:1,scale:n+1}:{step:s[r],scale:n}},Re=e=>{const{datamin:t,datamax:n,userSpecifiedZoom:o}=e;let{pixelHeight:s}=e;s<=1&&(s=1);const i=o??1;return c.useMemo(()=>{if(t===void 0||n===void 0||t===n)return ue;const r=t/i,a=n/i,u=a-r,f=s/Me,d=s/xe,g=Le(u,d),x=g.step*Math.pow(10,g.scale);if(u/x<f)return console.warn("Error: Unable to compute valid y-axis step size. Suppressing display."),ue;const S=Pe(r,g.scale);return{ticks:je(S,r,a,x,g.scale),datamin:r,datamax:a}},[n,t,i,s])},_e=18,De=e=>{const{zoomTimeSelection:t,panTimeSelectionPct:n}=e,o=()=>t(1.3),s=()=>t(1/1.3),i=()=>n(-.3),r=()=>n(.3);return[{type:"button",title:"Time zoom in (+)",callback:o,icon:h.jsx(G.FaSearchPlus,{}),keyCode:173},{type:"button",title:"Time zoom out (-)",callback:s,icon:h.jsx(G.FaSearchMinus,{}),keyCode:61},{type:"button",title:"Shift time window back [left arrow]",callback:i,icon:h.jsx(G.FaArrowLeft,{}),keyCode:37},{type:"button",title:"Shift time window forward [right arrow]",callback:r,icon:h.jsx(G.FaArrowRight,{}),keyCode:39}]};const Fe=e=>h.jsx("span",{title:e.title,children:h.jsx(ke.SmallIconButton,{title:e.title,onClick:e.onClick,disabled:!!e.disabled,icon:e.icon},e.elementIndex)},e.elementIndex+"-span"),Xe=e=>e.useHorizontalLayout?h.jsx("span",{}):h.jsx("hr",{},e.elementIndex),He=e=>{const t=Number.isFinite(e.content)?e.content:0,n=e.contentSigFigs||0,o=Math.abs(t-Math.round(t))*10**(n+1)<1,s=Number.isFinite(e.content)?o&&!e.contentAlwaysShowDecimal?Math.round(t)+"":t.toFixed(e.contentSigFigs||2):e.content||"",i=e.useHorizontalLayout?"span":"div";return c.createElement(i,{key:e.elementIndex,title:e.title,style:{textAlign:"center",fontWeight:"bold",cursor:"default"}},s)},Ue=e=>{switch(e.subtype){case"checkbox":return h.jsx(Ve,{...e});case"slider":return h.jsx(ze,{...e});default:return h.jsxs("span",{children:["ERROR: Bad toggle subtype ",e.subtype]},e.elementIndex)}},Ve=e=>h.jsx("input",{type:"checkbox",checked:e.selected,onChange:e.onClick,title:e.title,disabled:e.disabled,style:{cursor:"pointer"}},e.elementIndex),ze=e=>h.jsx(ce.FormGroup,{children:h.jsx(ce.Switch,{checked:e.selected,size:"small",style:{left:-3},onChange:e.onClick,disabled:e.disabled,title:e.title})},e.elementIndex),$e=e=>{switch(e.type){case"button":return h.jsx(Fe,{...e});case"divider":return h.jsx(Xe,{...e});case"text":return h.jsx(He,{...e});case"toggle":return h.jsx(Ue,{...e});default:return h.jsx("span",{},e.elementIndex)}},Be=e=>(e||[]).map((t,n)=>({type:t.type||"button",subtype:t.subtype,title:t.title,onClick:t.callback,icon:t.icon||"",selected:t.selected,disabled:t.disabled,content:t.content,contentSigFigs:t.contentSigFigs,contentAlwaysShowDecimal:t.boolean,elementIndex:n})),Ge=e=>{const t=c.useMemo(()=>Be(e.customActions),[e.customActions]),n=c.useMemo(()=>t.map((i,r)=>h.jsx($e,{...i,useHorizontalLayout:e.useHorizontalLayout},r)),[t,e.useHorizontalLayout]),o=c.useMemo(()=>({width:e.width,height:e.height-(e.top||0),top:e.top??0,paddingTop:e.topPadding??0}),[e.width,e.height,e.top,e.topPadding]),s=e.useHorizontalLayout?"HorizontalToolbar":"VerticalToolbar";return h.jsx("div",{className:s,style:{...o},children:n})},de={type:"divider"},Ke=e=>{const{aboveDefault:t,belowDefault:n}=e||{},{zoomTimeSelection:o,panTimeSelectionPct:s}=K.useTimeSelection();return c.useMemo(()=>{const r=t?[...t,de]:[],a=n?[de,...n]:[],u=De({zoomTimeSelection:o,panTimeSelectionPct:s});return[...r,...u,...a]},[o,s,t,n])},qe=e=>{e&&(e._hasFocus=!0)},We=e=>{e&&(e._hasFocus=!1)},Ye=(e,t,n,o,s)=>{const i=c.useRef(void 0),r=c.useCallback(()=>{i.current&&(s?window.cancelAnimationFrame(i.current):window.clearTimeout(i.current),i.current=void 0)},[i,s]),a=c.useCallback(f=>{t(n,o),i.current=void 0},[i,n,t,o]);return{throttler:c.useCallback(f=>{e(n,f)&&!i.current&&(i.current=s?window.requestAnimationFrame(a):window.setTimeout(a,s))},[i,e,a,n,s]),cancelThrottled:r}},Ne=(e,t)=>{const{panStateRef:n}=e,{mouseX:o}=t;return!n.current.panning||n.current.pannedX===o?!1:(n.current.pannedX=o,!0)},Ee=(e,t)=>{const{panStateRef:n}=e,{secondsPerPixel:o,panTimeSelectionDeltaT:s}=t;if(n===void 0||(n==null?void 0:n.current)===void 0)return;const i=(n.current.anchorX??0)-(n.current.pannedX??0);i!==0&&(n.current.anchorX=n.current.pannedX,s&&s(o*i))},Oe=(e,t,n)=>{const o=c.useMemo(()=>({secondsPerPixel:t,panTimeSelectionDeltaT:n}),[t,n]);return Ye(Ne,Ee,e,o,50)},Ze=(e,t,n)=>{e.current.anchorX=t,e.current.panning=!1,e.current.pannedX=void 0,n()},Je=(e,t)=>{const n=t-(e.current.anchorX??t);Math.abs(n)>5&&(e.current.panning=!0)},Qe=(e,t)=>{e.current={},t()},Ae=e=>{var t;return((t=e.current)==null?void 0:t.panning)??!1},Ie=(e,t,n)=>{const o=c.useRef({}),s=c.useMemo(()=>({divElmt:e,panStateRef:o}),[e,o]),{throttler:i,cancelThrottled:r}=Oe(s,t,n),a=c.useCallback(g=>{Ze(o,g,r)},[o,r]),u=c.useCallback(g=>Je(o,g),[o]),f=c.useCallback(()=>Qe(o,r),[o,r]),d=c.useCallback(()=>Ae(o),[o]);return{setPanUpdate:i,resetAnchor:a,startPan:u,clearPan:f,isPanning:d}},et=(e,t)=>c.useCallback(n=>{const o=n.clientX-n.currentTarget.getBoundingClientRect().x-e,s=Math.max(0,Math.min(1,o/t));return{mouseX:o,fraction:s}},[e,t]),tt=(e,t,n)=>c.useCallback(s=>{if(e){const{mouseX:i}=t(s);n(i)}},[e,t,n]),nt=(e,t)=>c.useCallback(o=>{e&&(t(),We(e))},[e,t]),ot=(e,t,n)=>c.useCallback(s=>{if(e){const{fraction:i}=t(s);n(i,{event:s}),qe(e)}},[t,n,e]),st=(e,t,n,o)=>c.useCallback(i=>{e&&(t()||n(i),o())},[e,t,n,o]),it=(e,t,n,o)=>c.useCallback(i=>{if(!e)return;const{mouseX:r}=t(i);n(r),o({mouseX:r})},[e,t,n,o]),rt=(e,t,n,o)=>{const{setCurrentTimeFraction:s,panTimeSelection:i}=K.useTimeSelection(),r=et(e,t),a=c.useMemo(()=>n/t,[n,t]),{setPanUpdate:u,resetAnchor:f,startPan:d,clearPan:g,isPanning:x}=Ie(o,a,i),S=ot(o,r,s),_=tt(o,r,f),w=st(o,x,S,g),T=it(o,r,d,u),p=nt(o,g);return c.useMemo(()=>({handleMouseUp:w,handleMouseMove:T,handleMouseDown:_,handleMouseLeave:p}),[w,T,_,p])},at=[{name:"1ms",secondsPerTick:.001,countPerLargerUnit:10,scale_appropriate_label:e=>`${e%1e3} ms`},{name:"10ms",secondsPerTick:.01,countPerLargerUnit:10,scale_appropriate_label:e=>`${e*10%1e3} ms`},{name:"100ms",secondsPerTick:.1,countPerLargerUnit:10,scale_appropriate_label:e=>`${e*100%1e3} ms`},{name:"1s",secondsPerTick:1,countPerLargerUnit:10,scale_appropriate_label:e=>`${e%60} s`},{name:"10s",secondsPerTick:10,countPerLargerUnit:6,scale_appropriate_label:e=>`${e*10%60} s`},{name:"1min",secondsPerTick:60,countPerLargerUnit:10,scale_appropriate_label:e=>`${e%60} min`},{name:"10min",secondsPerTick:60*10,countPerLargerUnit:6,scale_appropriate_label:e=>`${e*10%60} min`},{name:"1hr",secondsPerTick:60*60,countPerLargerUnit:6,scale_appropriate_label:e=>`${e%24} hr`},{name:"6hr",secondsPerTick:60*60*6,countPerLargerUnit:4,scale_appropriate_label:e=>`${e*6%24} hr`},{name:"1day",secondsPerTick:60*60*24,countPerLargerUnit:10,scale_appropriate_label:e=>`${e} day`},{name:"10day",secondsPerTick:60*60*24*10,countPerLargerUnit:1e4,scale_appropriate_label:e=>`${10*e} day`}],ct=(e,t,n,o)=>c.useMemo(()=>{if(t===void 0||n===void 0)return[];if(n<=t)return[];const s=[],i=e/(n-t);for(const r of at){const a=i*r.secondsPerTick;if(a<=50)continue;const u=Math.ceil(t/r.secondsPerTick),f=Math.floor(n/r.secondsPerTick),d=a>200||f-u<5;for(let g=u;g<=f;g++){if(g%r.countPerLargerUnit===0)continue;const x=g*r.secondsPerTick;s.push({value:x,label:r.scale_appropriate_label(g),major:d,pixelXposition:o(x)})}}return s},[t,n,o,e]),lt={position:"absolute",left:0,top:0},ut=e=>{if(!e||typeof e=="function")return;const t=e.current,n=t&&t.getContext("2d");if(n)return n},me=e=>{const{width:t,height:n,vOffsetPx:o,hOffsetPx:s,draw:i,drawData:r}=e,a=c.useRef(null);c.useEffect(()=>{const g=ut(a);g&&g.canvas&&i(g,r)},[i,a,r]);const d={...lt,...o?{top:o}:{},...s?{left:s}:{}};return h.jsx("canvas",{ref:a,width:t,height:n,style:d})},dt=(e,t)=>{const{width:n,height:o,margins:s,timeTicks:i,gridlineOpts:r,yTickSet:a}=t;e.clearRect(0,0,e.canvas.width,e.canvas.height);const u=o-s.bottom;ht(e,i,u,s.top,{hideGridlines:r==null?void 0:r.hideX}),e.strokeStyle="black",N(e,s.left,u,n-s.right,u),a&&mt(e,a,u,s.left,n-s.right,s.top,{hideGridlines:r==null?void 0:r.hideY})},ht=(e,t,n,o,s)=>{if(!t||t.length===0)return;const i=2,r=n+5;e.textAlign="center",e.textBaseline="top",t.forEach(a=>{e.strokeStyle=a.major?"gray":"lightgray";const u=s.hideGridlines?n:o;N(e,a.pixelXposition,r,a.pixelXposition,u),e.fillStyle=a.major?"black":"gray",e.fillText(a.label,a.pixelXposition,r+i)})},mt=(e,t,n,o,s,i,r)=>{const u=o-5,f=u-2,{ticks:d}=t;e.fillStyle="black",e.textAlign="right",e.textBaseline="middle",d.forEach(g=>{if(!g.pixelValue)return;const x=g.pixelValue+i;e.strokeStyle=g.isMajor?"gray":"lightgray",e.fillStyle=g.isMajor?"black":"gray";const S=r.hideGridlines?o:s;N(e,u,x,S,x),e.fillText(g.label,f,x)})},N=(e,t,n,o,s)=>{e.beginPath(),e.moveTo(t,n),e.lineTo(o,s),e.stroke()},gt={},bt=e=>{const{width:t,height:n}=e,o=c.useCallback(s=>{dt(s,e)},[e]);return h.jsx(me,{width:t,height:n,draw:o,drawData:gt})},ft=(e,t)=>{const{margins:n,currentTimePixels:o,currentTimeIntervalPixels:s}=t;if(e.clearRect(0,0,e.canvas.width,e.canvas.height),s!==void 0){e.fillStyle="rgba(255, 225, 225, 0.4)",e.strokeStyle="rgba(150, 50, 50, 0.9)";const i=s[0],r=n.top,a=s[1]-s[0],u=e.canvas.height-n.bottom-n.top;e.fillRect(i,r,a,u),e.strokeRect(i,r,a,u)}o!==void 0&&s===void 0&&(e.strokeStyle="red",e.beginPath(),e.moveTo(o,n.top),e.lineTo(o,e.canvas.height-n.bottom),e.stroke())},vt=e=>{const{width:t,height:n,timeRange:o,currentTimePixels:s,currentTimeIntervalPixels:i,margins:r}=e,a=c.useMemo(()=>({width:t,height:n,timeRange:o,currentTimePixels:s,currentTimeIntervalPixels:i,margins:r}),[t,n,o,s,i,r]);return h.jsx(me,{width:t,height:n,draw:ft,drawData:a})},he={left:45,right:20,top:20,bottom:40},ge=({width:e,height:t,hideToolbar:n,leftMargin:o})=>{const s=c.useMemo(()=>({...he,left:o||he.left}),[o]),i=n?0:_e,r=e-i;return{margins:s,canvasWidth:r,canvasHeight:t,toolbarWidth:i}},Tt=({width:e,height:t,onCanvasElement:n,gridlineOpts:o,onKeyDown:s,onMouseDown:i,onMouseMove:r,onMouseOut:a,onMouseUp:u,hideToolbar:f,yAxisInfo:d,shiftZoom:g,additionalToolbarItems:x,showTimeSelectionBar:S,leftMargin:_})=>{const{currentTimeSec:w,visibleStartTimeSec:T,visibleEndTimeSec:p,zoomTimeSelection:C,panTimeSelectionPct:z}=K.useTimeSelection(),H=c.useMemo(()=>[T,p],[T,p]),q=t-(S?V:0),{margins:v,canvasWidth:m,canvasHeight:b,toolbarWidth:F}=ge({width:e,height:q,hideToolbar:f,leftMargin:_}),k=c.useMemo(()=>T===void 0||p===void 0?()=>0:p<=T?()=>0:l=>v.left+(l-T)/(p-T)*(m-v.left-v.right),[m,T,p,v]),y=c.useMemo(()=>T===void 0||p===void 0?()=>0:p<=T?()=>0:l=>T+(l-v.left)/(m-v.left-v.right)*(p-T),[m,T,p,v]),j=c.useMemo(()=>{const l=(d==null?void 0:d.yMin)||0,D=(d==null?void 0:d.yMax)||0;return D<=l?()=>0:B=>b-v.bottom-(B-l)/(D-l)*(b-v.top-v.bottom)},[d,b,v]),L=ct(m,T,p,k),M=Re({datamin:(d==null?void 0:d.yMin)||0,datamax:(d==null?void 0:d.yMax)||0,pixelHeight:b-v.left-v.right}),R=c.useMemo(()=>({datamin:M.datamin,datamax:M.datamax,ticks:M.ticks.map(l=>({...l,pixelValue:j(l.dataValue)}))}),[M,j]),P=c.useMemo(()=>h.jsx(bt,{width:m,height:b,timeRange:H,margins:v,timeTicks:L,yTickSet:d!=null&&d.showTicks?R:void 0,gridlineOpts:o}),[o,m,b,H,v,L,d==null?void 0:d.showTicks,R]),$=c.useMemo(()=>w!==void 0?k(w):void 0,[w,k]),X=c.useMemo(()=>h.jsx(vt,{width:m,height:b,timeRange:H,margins:v,currentTimePixels:$}),[m,b,H,v,$]),[U,O]=c.useState(null);c.useEffect(()=>{if(!U)return;const l=D=>{U._hasFocus&&D.preventDefault()};return U.addEventListener("wheel",l),()=>{U.removeEventListener("wheel",l)}},[U]);const be=(p??0)-(T??0),{handleMouseDown:Z,handleMouseUp:J,handleMouseLeave:Q,handleMouseMove:A}=rt(v.left,m-v.left-v.right,be,U),[,I]=c.useState(void 0),ee=c.useCallback(l=>{if(g&&!l.shiftKey||l.deltaY===0)return;const D=l.clientX-l.currentTarget.getBoundingClientRect().x,B=y(D),ve=-l.deltaY/100;C(ve>0?1.1:1/1.1,B)},[C,y,g]),te=c.useCallback(l=>{l.key==="="?C(1.3):l.key==="-"?C(1/1.3):l.key==="ArrowRight"?z(.3):l.key==="ArrowLeft"&&z(-.3),s&&s(l)},[s,C,z]),ne=c.useCallback(l=>{!l.shiftKey&&!l.ctrlKey&&!l.altKey?Z(l):i&&i(l)},[Z,i]),oe=c.useCallback(l=>{!l.shiftKey&&!l.ctrlKey&&!l.altKey?J(l):u&&u(l)},[J,u]),se=c.useCallback(l=>{const D=l.clientX-l.currentTarget.getBoundingClientRect().x,B=y(D);I(B),!l.shiftKey&&!l.ctrlKey&&!l.altKey&&A(l),r&&r(l)},[A,r,y]),ie=c.useCallback(l=>{I(void 0),!l.shiftKey&&!l.ctrlKey&&!l.altKey&&Q(l),a&&a(l)},[Q,a]),re=c.useMemo(()=>h.jsxs("div",{style:{position:"relative",overflow:"hidden",width:m,height:b},onWheel:ee,onMouseDown:ne,onMouseUp:oe,onMouseMove:se,onMouseOut:ie,tabIndex:0,onKeyDown:te,children:[P,h.jsx("canvas",{style:{position:"absolute",width:m,height:b},ref:n,width:m,height:b}),X]}),[n,P,X,m,b,te,ee,ne,oe,se,ie]),fe=Ke({belowDefault:x}),ae=S?h.jsxs("div",{style:{position:"absolute",width:m,height:t},children:[h.jsx("div",{style:{position:"absolute",width:m,height:V},children:h.jsx(ye,{width:m,height:V-5})}),h.jsx("div",{style:{position:"absolute",top:V,width:m,height:t-V},children:re})]}):re;return f?h.jsx("div",{ref:l=>O(l),style:{position:"absolute",width:e,height:t,background:"white"},children:ae}):h.jsx("div",{className:"TimeScrollView",ref:l=>O(l),style:{position:"relative",width:e,height:t,overflow:"hidden"},children:h.jsxs(Te.Splitter,{width:e,height:t,initialPosition:F,adjustable:!1,children:[h.jsx(Ge,{width:0,height:0,top:S?V:0,customActions:fe}),ae]})})};exports.TimeScrollView=Tt;exports.useTimeScrollView=ge;
